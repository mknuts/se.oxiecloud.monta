<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; }
        .status-msg { 
            margin-top: 15px; 
            padding: 10px; 
            border-radius: 4px; 
            display: none; 
            font-size: 14px;
        }
        .success { display: block; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { display: block; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .homey-form-group { margin-bottom: 15px; }
        
        /* Styling f√∂r den nya informationssektionen */
        .info-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 13px;
            line-height: 1.5;
            color: #444;
        }
        .info-section h2 { font-size: 16px; color: #000; margin-bottom: 10px; }
        .info-section p { margin-bottom: 12px; }
        .info-section a { color: #8E1C16; text-decoration: none; font-weight: bold; }
        .info-section a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header class="homey-header">
        <h1 class="homey-title" data-i18n="settings.title">Monta</h1>
        <p class="homey-subtitle" data-i18n="settings.subtitle">Konfigurera dina API-uppgifter</p>
    </header>

    <fieldset class="homey-form-fieldset">
        <div class="homey-form-group">
            <label class="homey-form-label" for="username" data-i18n="settings.username">Client ID</label>
            <input class="homey-form-input" id="username" type="text" value="" />
        </div>
        <div class="homey-form-group">
            <label class="homey-form-label" for="password" data-i18n="settings.password">Client Secret</label>
            <input class="homey-form-input" id="password" type="password" value="" />
        </div>
    </fieldset>

    <div style="display: flex; flex-direction: column; gap: 10px;">
        <button id="save" class="homey-button-primary-full" data-i18n="settings.save">Spara</button>
        <button id="test" class="homey-button-secondary-full" data-i18n="settings.test">Testa anslutning</button>
    </div>

    <div id="status" class="status-msg"></div>

    <div class="info-section">
        <h2 data-i18n="settings.instructions_title">Instructions</h2>
        <p style="white-space: pre-wrap;" data-i18n="settings.instructions_body">
            To use this app you need to connect your EV charger to Montas backend...
        </p>
    </div>

    <script type="text/javascript">
        function onHomeyReady(Homey) {
            const usernameEl = document.getElementById('username');
            const passwordEl = document.getElementById('password');
            const statusEl = document.getElementById('status');
            const saveBtn = document.getElementById('save');
            const testBtn = document.getElementById('test');

            Homey.get('username', (err, val) => { if(val) usernameEl.value = val; });
            Homey.get('password', (err, val) => { if(val) passwordEl.value = val; });

            saveBtn.onclick = () => {
                Homey.set('username', usernameEl.value);
                Homey.set('password', passwordEl.value);
                Homey.alert(Homey.__('settings.saved'));
            };

            testBtn.onclick = () => {
                statusEl.className = 'status-msg';
                statusEl.innerText = Homey.__('settings.testing'); 
                statusEl.style.display = 'block';

                Homey.api('POST', '/test-connection', {
                    username: usernameEl.value,
                    password: passwordEl.value
                }, (err, result) => {
                    if (err || !result.success) {
                        const errorMsg = result ? result.message : (err ? err.message : 'Unknown');
                        statusEl.innerText = Homey.__('settings.error') + errorMsg;
                        statusEl.className = 'status-msg error';
                    } else {
                        statusEl.innerText = Homey.__('settings.success');
                        statusEl.className = 'status-msg success';
                    }
                });
            };

            Homey.ready();
        }
    </script>
</body>
</html>